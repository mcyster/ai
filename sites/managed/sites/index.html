<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Website List</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@3"></script>
    <script src="/sites/managed/chat/chat.js" data-scenario="WebDeveloper" data-href-site-name="/([^/]+)/[^/]+$"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        h2 {
            color: #333;
        }
        ul {
            list-style-type: none;
            padding: 0;
        }
        li {
            margin: 5px 0;
        }
        .button {
            margin-left: 10px;
            cursor: pointer;
        }
        .flash {
            animation: flashAnimation 1.5s ease-in-out 3;
        }
        @keyframes flashAnimation {
            0%, 100% { background-color: yellow; }
            50% { background-color: transparent; }
        }
        #tagsList {
            margin-bottom: 20px;
        }
        .tag-checkbox {
            margin-left: 5px;
        }
        .site-tags {
            margin-top: 5px;
            font-size: 0.9em;
            color: #555;
        }
        .site-tag {
            cursor: pointer;
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <h2>Websites</h2>
    <div id="tagsList"></div>
    <ul id="websiteList"></ul>

    <script>
        async function fetchWebsites() {
            try {
                let url = '/pages';
                const urlParams = new URLSearchParams(window.location.search);
                const tags = urlParams.get('tags');
                if (tags) {
                    url += `?tags=${tags}`;
                }
                const response = await fetch(url);
                const websites = await response.json();
                displayWebsites(websites);
                displayTags(tags);
            } catch (error) {
                console.error('Error fetching websites:', error);
            }
        }

        function displayWebsites(websites) {
            const websiteList = document.getElementById('websiteList');
            websiteList.innerHTML = '';

            websites.forEach(website => {
                const listItem = document.createElement('li');
                const link = document.createElement('a');
                link.href = website.uri;
                link.textContent = website.name;
                listItem.appendChild(link);

                const copyButton = document.createElement('button');
                copyButton.textContent = 'copy';
                copyButton.className = 'button';
                copyButton.onclick = () => copyWebsite(website.name);
                listItem.appendChild(copyButton);

                if (website.type === 'Temporary') {
                    const editButton = document.createElement('button');
                    editButton.textContent = 'edit';
                    editButton.className = 'button';
                    editButton.onclick = () => editWebsite(website.type, website.name);
                    listItem.appendChild(editButton);

                    const nameButton = document.createElement('button');
                    nameButton.textContent = 'name';
                    nameButton.className = 'button';
                    nameButton.onclick = () => nameWebsitePrompt(website.name);
                    listItem.appendChild(nameButton);
                }

                // Display site tags
                if (website.tags && website.tags.length > 0) {
                    const tagsContainer = document.createElement('div');
                    tagsContainer.className = 'site-tags';

                    website.tags.forEach(tag => {
                        const tagSpan = document.createElement('span');
                        tagSpan.className = 'site-tag';
                        tagSpan.textContent = tag;
                        tagSpan.onclick = () => addTag(tag);
                        tagsContainer.appendChild(tagSpan);
                    });

                    listItem.appendChild(tagsContainer);
                }

                websiteList.appendChild(listItem);
            });
        }

        function displayTags(tags) {
            const tagsList = document.getElementById('tagsList');
            tagsList.innerHTML = '';
            if (tags) {
                const tagsArray = tags.split(',');
                tagsArray.forEach(tag => {
                    const tagLabel = document.createElement('label');
                    tagLabel.textContent = tag;

                    const tagCheckbox = document.createElement('input');
                    tagCheckbox.type = 'checkbox';
                    tagCheckbox.className = 'tag-checkbox';
                    tagCheckbox.checked = true;
                    tagCheckbox.onchange = () => updateTags(tag);

                    tagLabel.appendChild(tagCheckbox);
                    tagsList.appendChild(tagLabel);
                });
            }
        }

        function updateTags(tag) {
            const urlParams = new URLSearchParams(window.location.search);
            let tagsArray = urlParams.get('tags').split(',');
            tagsArray = tagsArray.filter(t => t !== tag);
            if (tagsArray.length > 0) {
                urlParams.set('tags', tagsArray.join(','));
            } else {
                urlParams.delete('tags');
            }

            const newUrl = `${window.location.pathname}?${urlParams.toString()}`;
            window.location.href = newUrl;
        }

        function addTag(tag) {
            const urlParams = new URLSearchParams(window.location.search);
            let tagsArray = urlParams.get('tags') ? urlParams.get('tags').split(',') : [];
            if (!tagsArray.includes(tag)) {
                tagsArray.push(tag);
                urlParams.set('tags', tagsArray.join(','));
            }

            const newUrl = `${window.location.pathname}?${urlParams.toString()}`;
            window.location.href = newUrl;
        }

        async function copyWebsite(name) {
            try {
                const response = await fetch(`/pages/${name}/copy`, { method: 'POST' });
                const newWebsite = await response.json();
                fetchWebsites();
                setTimeout(() => flashNewWebsite(newWebsite.uri), 100); 
            } catch (error) {
                console.error('Error copying website:', error);
            }
        }

        function editWebsite(type, name) {
            const typePath = type.toLowerCase();
            const url = `/sites/${typePath}/${name}/index.html`;
            window.location.href = url;
        }

        async function nameWebsite(name, newName) {
            try {
                const response = await fetch(`/pages/${name}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name: newName })
                });
                const namedWebsite = await response.json();
                fetchWebsites();
                setTimeout(() => flashNewWebsite(namedWebsite.uri), 100); 
            } catch (error) {
                console.error('Error naming website:', error);
            }
        }

        function nameWebsitePrompt(name) {
            const newName = prompt('Enter the new name for the website:');
            if (newName) {
                nameWebsite(name, newName);
            }
        }

        function flashNewWebsite(uri) {
            const linkElements = document.querySelectorAll(`a[href='${uri}']`);
            linkElements.forEach(link => {
                const listItem = link.parentElement;
                listItem.classList.add('flash');
                setTimeout(() => {
                    listItem.classList.remove('flash');
                }, 4500); 
            });
        }

        window.onload = fetchWebsites;
    </script>
</body>
</html>