<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Report Dashboard</title>
    <meta name="tags" content="extole,tickets,reports">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/typescript@latest"></script>
    <script src="/sites/managed/chat/chat.js" data-scenario="WebDeveloper" data-href-website-id="/([^/]+)/[^/]+$"></script>
    <script src="./data.js"></script>
    <style>
        #graphTitle {
            text-align: center;
            margin-top: 20px;
            margin-bottom: 20px;
        }
        .chart-container {
            width: 80%;
            margin: auto;
            max-width: 2400px;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="chart-container">
            <h2 id="graphTitle">Event Counts by Period</h2>
            <canvas id="chart"></canvas>
        </div>
    </div>

    <script id="typescript-code" type="text/typescript">
        interface Event {
          period_end: string | null;
          client_id: string | null;
          client_name: string | null;
          client_type: string | null;
          vertical: string | null;
          client_status: string | null;
          integration_name: string | null;
          integration_type: string | null;
          destination: string | null;
          events: any | null; // Adjust the type based on the structure of events
          events_count: number;
        }

        async function getReport(): Promise<Event[]> {
            var extoleClientId = "1890234003";
            var reportRunnerId = "s869x14kpawsodmdk0f8";
            var data = await getData(extoleClientId, reportRunnerId);
            if (reportRunnerId != "s869x14kpawsodmdk0f8") {
                throw new Error(`Update the typeData in getReport to match the reportRunnerId: ${reportRunnerId} for client ${extoleClientId}`);
            }
            const events = data.map(item => ({
                period_end: item.period_end || null,
                client_id: item.client_id || null,
                client_name: item.client_name || null,
                client_type: item.client_type || null,
                vertical: item.vertical || null,
                client_status: item.client_status || null,
                integration_name: item.integration_name || null,
                integration_type: item.integration_type || null,
                destination: item.destination || null,
                events: item.events || null, // Adjust the type based on the structure of events
                events_count: item.events_count || 0
            }));
            console.log(events);
            return events;
        }

        function countEventsPerPeriod(events: Event[]) {
            const eventCounts: { [period: string]: number } = {};
            events.forEach(event => {
                const period = event.period_end;
                eventCounts[period!] = (eventCounts[period!] || 0) + event.events_count;
            });
            return eventCounts;
        }

        function renderChart(eventCounts: { [period: string]: number }) {
            const ctx = document.getElementById('chart') as HTMLCanvasElement;
            if (!ctx) return;
            const periods = Object.keys(eventCounts).sort();
            const eventData = periods.map(period => ({ x: new Date(period), y: eventCounts[period] }));

            new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [
                        {
                            label: 'Event Counts',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            fill: false,
                            data: eventData,
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day',
                                tooltipFormat: 'PP',
                                displayFormats: {
                                    day: 'PP'
                                }
                            },
                            title: {
                                display: true,
                                text: 'Period',
                                font: {
                                    size: 16,
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                font: {
                                    weight: 'bold'
                                }
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Event Count',
                                font: {
                                    size: 16,
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                font: {
                                    weight: 'bold'
                                }
                            }
                        }
                    }
                }
            });
        }

        const app = {
            data() {
                return {
                    jsonData: []
                };
            },
            async created() {
                getReport().then(events => {
                    const eventCounts = countEventsPerPeriod(events);
                    renderChart(eventCounts);
                }).catch(error => {
                    console.error('Error loading data:', error);
                });
            }
        };

        Vue.createApp(app).mount('#app');
    </script>

    <script>
        (async function compileAndExecute() {
            const tsCode = document.getElementById('typescript-code').textContent;
            const jsCode = ts.transpile(tsCode, { target: ts.ScriptTarget.ES2017, module: ts.ModuleKind.None });
            eval(jsCode);
        })();
    </script>
</body>
</html>
