<html ng-app="jsonFormatterApp">
<head>
    <meta charset="UTF-8">
    <title>Extole Total Event Count Over TIme</title>
    <meta name="tags" content="extole,report,kpis,events">
    <script src="https://cdn.jsdelivr.net/npm/vue@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="/sites/managed/chat/chat.js" data-scenario="WebDeveloper" data-href-website-id="/([^/]+)/[^/]+$"></script>
    <script src="data.js"></script>
    <style>
        #graphTitle {
            text-align: center;
            margin-top: 20px;
            margin-bottom: 20px;
        }
        .chart-container {
            width: 80%;
            margin: auto;
            max-width: 2400px;
        }
        #jsonDisplay {
            padding: 20px;
            margin: 20px auto;
            width: 80%;
            max-width: 2400px;
            border: 1px solid #ddd;
            display: none;
        }
        .json-toggler {
            cursor: pointer;
            color: #007BFF;
            margin: 20px auto;
            width: 80%;
            max-width: 2400px;
            text-align: left;
        }
    </style>
</head>
<body>
    <div class="chart-container">
        <h2 id="graphTitle">Total Event Count Over Time</h2>
        <canvas id="chart"></canvas>
    </div>
    <div class="json-toggler" onclick="toggleJsonDisplay()">Show JSON Data</div>
    <div id="jsonDisplay"></div>
</body>
<script>
document.addEventListener("DOMContentLoaded", async function() {
    async function showData() {
        try {
            var data = await getReport();

            console.log('Data fetched successfully:', data);
            const dataDisplay = document.getElementById('jsonDisplay');
            if (data) {
                dataDisplay.innerHTML = '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
            } else {
                dataDisplay.innerHTML = '<pre>No data available</pre>';
            }

            // Group data by period_end and sum event counts
            const eventCountsByDate = data.reduce((acc, item) => {
                const date = item.period_end;
                acc[date] = (acc[date] || 0) + item.events_count;
                return acc;
            }, {});

            const labels = Object.keys(eventCountsByDate);
            const eventCounts = Object.values(eventCountsByDate);

            // Create the line chart
            const ctx = document.getElementById('chart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Total Event Count',
                        data: eventCounts,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        backgroundColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 4,
                        fill: false,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day'
                            },
                            title: {
                                display: true,
                                text: 'Date',
                                font: {
                                    weight: 'bold'
                                }
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Event Count',
                                font: {
                                    weight: 'bold'
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    }
                }
            });

        } catch (error) {
            console.error('Error fetching data:', error);
        }
    }

    showData();
});

function toggleJsonDisplay() {
    const jsonDisplay = document.getElementById('jsonDisplay');
    const toggler = document.querySelector('.json-toggler');
    if (jsonDisplay.style.display === 'none' || jsonDisplay.style.display === '') {
        jsonDisplay.style.display = 'block';
        toggler.innerText = 'Hide JSON Data';
    } else {
        jsonDisplay.style.display = 'none';
        toggler.innerText = 'Show JSON Data';
    }
}

async function getReport() {
    var extoleClientId = "1890234003";
    var reportRunnerId = "s869x14kpawsodmdk0f8";
    var data = await getTypedData(extoleClientId, reportRunnerId);

    if (reportRunnerId != "s869x14kpawsodmdk0f8") {
        throw new Error(`Update the typeData in getReport to match the reportRunnerId: ${reportRunnerId} for client ${extoleCientId}`);
    }

    var typedData = data.map(item => ({
        period_end: item.period_end || null,
        client_id: item.client_id || null,
        client_name: item.client_name || null,
        client_type: item.client_type || null,
        vertical: item.vertical || null,
        client_status: item.client_status || null,
        integration_name: item.integration_name || null,
        integration_type: item.integration_type || null,
        destination: item.destination || null,
        events: item.events || null,
        events_count: item.events_count || 0,
    }));

    return typedData;
}

</script>
</html>
